#!/usr/bin/env bash
# display schema for the specified tables.
# vim: expandtab

alltables=false
istest=false
db=tat_development
user=tat
tbcmd='\dt'
desc='\d'
if [ "$ALL" ]; then
    alltables=true
fi

ruby_to_table() {
  table=$1
  if expr $1 : '.*\.rb$' >/dev/null; then
    table=$(basename $table|sed 's@\.rb@s@')
  fi
  echo $table
}

filter() {
    cat -|
    awk '
        /ar_internal_metadata/ {next}
        /schema_migrations/ {next}
        /^---*/ {ready=1}
        (ready) {print $3}
        '|egrep -v '^$'
}

case "$1" in
    -t*) istest=true;shift
        ;;
esac

if [ "$DB" ] || eval $istest; then
    db=$DB
fi
if [ $# -eq 0 ]; then
    echo "$tbcmd"|psql -U $user -d $db|filter|awk '{print "[" NR "] " $0}'
fi

args=$*
for t in $args; do
    if expr $t : '^[0-9][0-9]*$' >/dev/null; then
        table=$(echo "$tbcmd"|psql -U $user -d $db|filter|sed -n "${t}p")
    else
        table=$(ruby_to_table $t)
    fi
    echo "$desc $table"|psql -U $user -d $db|sed 's@, *@\
@g'
done
